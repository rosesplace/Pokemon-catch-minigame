<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pok√©mon Overlay</title>
  <style>
    :root {
      --poke-scale: 1.5; /* base size multiplier */
    }

    body {
      margin: 0;
      background: transparent;
      overflow: hidden;
    }

    #pokemon {
      position: absolute;
      bottom: 50px;
      right: 50px;
      transform: scale(var(--poke-scale));
      max-width: 400px; /* bigger default sprite */
      display: none;
      z-index: 5;
    }

    #ball {
      position: absolute;
      width: 64px;
      display: none;
      z-index: 10;
    }

    /* Spawn: bounce pop */
    .spawn {
      animation: spawnAnim 0.8s ease-out;
    }
    @keyframes spawnAnim {
      0%   { transform: scale(calc(var(--poke-scale) * 0)); opacity: 0; }
      60%  { transform: scale(calc(var(--poke-scale) * 1.3)); opacity: 1; }
      80%  { transform: scale(calc(var(--poke-scale) * 0.9)); }
      100% { transform: scale(var(--poke-scale)); opacity: 1; }
    }

    /* Idle breathing animation */
    .idle {
      animation: idleAnim 2.5s ease-in-out infinite;
    }
    @keyframes idleAnim {
      0%, 100% { transform: scale(var(--poke-scale)); }
      50%      { transform: scale(calc(var(--poke-scale) * 1.05)); }
    }

    /* Shrink into ball */
    .shrink {
      animation: shrinkAnim 0.6s forwards;
    }
    @keyframes shrinkAnim {
      from { transform: scale(var(--poke-scale)); opacity: 1; }
      to   { transform: scale(calc(var(--poke-scale) * 0.3)); opacity: 0.8; }
    }

    /* Restore after breakout */
    .restore {
      animation: restoreAnim 0.5s ease-out forwards;
    }
    @keyframes restoreAnim {
      from { transform: scale(calc(var(--poke-scale) * 0.3)); opacity: 0.8; }
      to   { transform: scale(var(--poke-scale)); opacity: 1; }
    }

    /* Ball bounce drop */
    .bounce {
      animation: bounce 0.4s ease-out;
    }
    @keyframes bounce {
      0% { transform: translateY(-200px); opacity: 0; }
      50% { transform: translateY(-20px); opacity: 1; }
      70% { transform: translateY(-10px); }
      100% { transform: translateY(0); }
    }

    /* Ball shakes */
    .shake1 { animation: shake 0.3s ease; }
    .shake2 { animation: shake 0.3s ease 1s; }
    .shake3 { animation: shake 0.3s ease 2s; }

    @keyframes shake {
      0% { transform: translate(0, 0) rotate(0deg); }
      25% { transform: translate(-5px, -5px) rotate(-15deg); }
      50% { transform: translate(0, 0) rotate(0deg); }
      75% { transform: translate(5px, -5px) rotate(15deg); }
      100% { transform: translate(0, 0) rotate(0deg); }
    }

    /* Ball vanish on success */
    .vanish { animation: vanish 0.5s forwards; }
    @keyframes vanish {
      from { opacity: 1; transform: scale(0.3); }
      to   { opacity: 0; transform: scale(0); }
    }

    /* Ball breakout pop */
    .breakout {
      animation: breakoutAnim 0.5s forwards;
    }
    @keyframes breakoutAnim {
      0%   { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.5); opacity: 0; }
    }
  </style>
</head>
<body>
  <img id="pokemon" src="">
  <img id="ball" src="assets/balls/pokeball.png">

  <audio id="throwSound" src="assets/sounds/throw.mp3"></audio>
  <audio id="shakeSound" src="assets/sounds/shake.mp3"></audio>
  <audio id="catchSound" src="assets/sounds/catch.mp3"></audio>
  <audio id="breakoutSound" src="assets/sounds/breakout.mp3"></audio>

  <script>
    const pokemon = document.getElementById("pokemon");
    const ball = document.getElementById("ball");
    const throwSound = document.getElementById("throwSound");
    const shakeSound = document.getElementById("shakeSound");
    const catchSound = document.getElementById("catchSound");
    const breakoutSound = document.getElementById("breakoutSound");

    const ws = new WebSocket("ws://localhost:8080");

    function centerBallOverPokemon() {
      const pokeRect = pokemon.getBoundingClientRect();
      const overlayRect = document.body.getBoundingClientRect();
      const centerX = pokeRect.left + pokeRect.width / 2;
      const centerY = pokeRect.top + pokeRect.height / 2;
      ball.style.left = (centerX - ball.width / 2 - overlayRect.left) + "px";
      ball.style.top = (centerY - ball.height / 2 - overlayRect.top) + "px";
    }

    function resetClasses(el) {
      el.className = "";
    }

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === "spawn") {
        resetClasses(pokemon);
        pokemon.src = data.sprite;
        pokemon.style.display = "block";
        void pokemon.offsetWidth;
        pokemon.classList.add("spawn");
        // add idle breathing after spawn finishes
        setTimeout(() => {
          pokemon.classList.add("idle");
        }, 800);
      }

      if (data.type === "catch") {
        resetClasses(ball);
        pokemon.classList.remove("idle");

        ball.style.display = "block";
        ball.src = `assets/balls/${data.ballType || "pokeball"}.png`;
        centerBallOverPokemon();

        ball.classList.add("bounce");
        throwSound.play();

        pokemon.classList.add("shrink");

        // shakes
        setTimeout(() => { ball.classList.add("shake1"); shakeSound.play(); }, 1500);
        setTimeout(() => { ball.classList.add("shake2"); shakeSound.play(); }, 2500);
        setTimeout(() => { ball.classList.add("shake3"); shakeSound.play(); }, 3500);

        if (data.success) {
          setTimeout(() => {
            pokemon.classList.add("vanish");
            catchSound.play();
            setTimeout(() => {
              pokemon.style.display = "none";
              ball.style.display = "none";
              resetClasses(pokemon);
              resetClasses(ball);
            }, 700);
          }, 4000);
        } else {
          setTimeout(() => {
            breakoutSound.play();
            ball.classList.add("breakout");
            pokemon.classList.add("restore");
            setTimeout(() => {
              ball.style.display = "none";
              resetClasses(ball);
              resetClasses(pokemon);
              pokemon.classList.add("idle");
            }, 600);
          }, 4000);
        }
      }

      if (data.type === "despawn") {
        pokemon.style.display = "none";
        ball.style.display = "none";
        resetClasses(pokemon);
        resetClasses(ball);
      }
    };
  </script>
</body>
</html>
